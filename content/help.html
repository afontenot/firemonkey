<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="iframe.css">
    <link rel="stylesheet" href="highlight.css">
    <title>Help</title>
  </head>
  <body>

  <nav>
    <a href="#Preamble">Preamble</a>
    <div><a href="#how_to">How to Use</a>
      <ul>
        <li><a href="#toolbar-menu">Toolbar Icon Context Menu</a></li>
        <li><a href="#toolbar-badge">Toolbar Icon Badge</a></li>
        <li><a href="#toolbar-title">Toolbar Icon Title</a></li>
        <li><a href="#toolbar-popup">Toolbar Icon Pop-up</a></li>
        <li><a href="#web-install">Web Install</a></li>
        <li><a href="#direct-install">Direct Install</a></li>
      </ul>
    </div>
    <div><a href="#options">Options</a>
      <ul>
        <li><a href="#auto-update-interval">Auto-Update Interval</a></li>
        <li><a href="#global-script-exclude">Global Script Exclude Matches</a></li>
        <li><a href="#enable-storage">Enable Storage Sync</a></li>
        <li><a href="#counter">Counter</a></li>
        <li><a href="#import-export">Preferences: Import/Export</a></li>
        <li><a href="#save">Save</a></li>
      </ul>
    </div>
    <div><a href="#Script-CSS">Script & CSS</a>
      <ul>
        <li><a href="#editing">Editing</a></li>
        <li><a href="#syntax-highlighting">Syntax Highlighting</a></li>
        <li><a href="#self-update">Self-Update</a></li>
        <li><a href="#auto-update">Update & Auto-Update</a></li>
        <li><a href="#user-matches-exclude">User Matches & Exclude Matches</a></li>
        <li class="arrow"><a href="#metadata-block">Metadata Block</a>
          <ul>
            <li><a href="#match-patterns">Match Patterns</a></li>
            <li><a href="#ftp">FTP</a></li>
            <li><a href="#tld">TLD</a></li>
            <li><a href="#require">require</a></li>
            <li><a href="#storing-require-resource">Storing require & resource Targets</a></li>
            <li><a href="#grant">grant</a></li>
          </ul>
        </li>

        <li class="arrow"><a href="#script-api">Script API</a>
          <ul>
            <li><a href="#fetch">fetch</a></li>
            <li><a href="#xmlHttpRequest">xmlHttpRequest</a></li>
            <li><a href="#forbidden-header-name">Forbidden header name</a></li>
            <li><a href="#notification">notification</a></li>
            <li><a href="#registerMenuCommand">registerMenuCommand</a></li>
            <li><a href="#unregisterMenuCommand">unregisterMenuCommand</a></li>
            <li><a href="#getResourceText">getResourceText</a></li>
            <li><a href="#getResourceUrl">getResourceUrl</a></li>
            <li><a href="#addValueChangeListener">addValueChangeListener</a></li>
            <li><a href="#removeValueChangeListener">removeValueChangeListener</a></li>
            <li><a href="#download">download</a></li>
            <li><a href="#info">info</a></li>
            <li><a href="#log">log</a></li>
            <li><a href="#unsafeWindow">unsafeWindow</a></li>
          </ul>
        </li>
        <li><a href="#xray-vision">Xray Vision & Sharing objects with page scripts</a></li>
        <li><a href="#UserCSS">UserCSS</a></li>
        <li><a href="#UserStyle">UserStyle</a></li>
        <li><a href="#stylish-stylus">Stylish/Stylus/xStyle Type UserStyle</a></li>

      </ul>
    </div>
    <a href="#support">Support</a>
  </nav>

  <article>


  <h2 id="Preamble">Preamble</h2>
  <p><i>FireMonkey</i> is a totally new combined user-script and user-style manager. While it has similar functions to other user-Script managers like <i>GreaseMonkey/TamperMonkey/ViolentMonkey</i>, and user-style managers like <i>Stylish/Stylus/xStyle</i>, there are also differences. Similar to <i>GreaseMonkey</i>, scripts (or CSS) are injected in tabs and for a new script/CSS to have an effect, tab must be reloaded. The behaviour differs from <i>Stylus</i> which can inject CSS into a tab and remove it without having to reload the tab.</p>


  <h2 id="how_to">How to Use</h2>


  <h3 id="toolbar-menu"><img src="../image/icon.svg" alt=""> Toolbar Icon Context Menu</h3>

  <dl>
    <dt><img src="../image/gear.svg" alt=""> Options</dt>
      <dd>Open the Options page</dd>
      
    <dt><img src="../image/js.svg" alt=""> New UserScript</dt>
      <dd>Open the Options page and display a new Script Template that you can edit and Save</dd>
      <dd><i>(In Private Window opens the Options page ref bug 1659998)</i></dd>
      
    <dt><img src="../image/css.svg" alt=""> New UserCSS</dt>
      <dd>Open the Options page and display a new CSS Template that you can edit and Save</dd>
      <dd><i>(In Private Window opens the Options page ref bug 1659998)</i></dd>

    <dt><img src="../image/help32.png" alt=""> Help</dt>
      <dd>Display Help document</dd>
      <dd><i>(In Private Window opens the Options page ref bug 1659998)</i></dd>
  </dl>

  <h3 id="toolbar-badge"><sup>5</sup> Toolbar Icon Badge</h3>
    <p>Badge indicates the number of Script/CSS that are active in the tab (and all its iframes)</p>

  <h3 id="toolbar-title"><img src="../image/icon.svg" alt=""> Toolbar Icon Title</h3>
    <p>Mouse-over Title displays active Script/CSS</p>

  <h3 id="toolbar-popup"><img src="../image/icon.svg" alt=""> Toolbar Icon Pop-up</h3>
    <p>The pop-up displays the installed Scripts/CSS. "Tab Scripts & CSS" shows the ones running on the active Tab</p>

    <dl>
      <dt style="color: #05f;">✔</dt>
        <dd>Shows Script/CSS is enabled. Disabled Script/CSS are greyed out and clicking that area toggles the enable/disable</dd>

      <dt><span class="fail"></span></dt>
        <dd>Shows that there was an error when registering the script & the Information page displays the error</dd>

      <dt><img src="../image/next.svg" alt=""></dt> 
        <dd>Shows the Information for the Script/CSS</dd>

      <dt>&#x1f58c; Edit</dt>  
        <dd>Button on Information page opens the Options Page and selects the current Script/CSS</dd>

      <dt><img src="../image/gear.svg" alt=""> Options</dt>
        <dd>Open the Options Page</dd>      
      
      <dt>Script Commands &nbsp;&nbsp;&nbsp;<img src="../image/next.svg" alt=""></dt>
        <dd>Shows available Script Commands</dd>

      <dt>&#x2795; <img src="../image/js.svg" alt=""></dt> 
        <dd>Display a new Script Template that you can edit and Save</dd>

      <dt>&#x2795; <img src="../image/css.svg" alt=""></dt> 
        <dd>Display a new CSS Template that you can edit and Save</dd>

      <dt>Help</dt> 
        <dd>Open the Help document</dd>

    </dl>



  <h3 id="web-install">Web Install</h3>
  <p>Web Install is available from <i>greasyfork.org</i> & <i>openuserjs.org</i>. Script install URL will be set for script update.</p>

  <h3 id="direct-install">Direct Install</h3>
  <p>Scripts can be directly installed from any script ending in <code>.user.js </code> (remote or local file system) if loaded into a tab (open or drag & drop)</p>
  <p>In case of <i>greasyfork.org</i> & <i>openuserjs.org</i> links, the same link will be set for script update.</p>
  <p>Due to sandbox CSP header on <code>https://raw.githubusercontent.com/........uers.js</code> tab is forwarded to <code>cdn.jsdelivr.net</code> mirror. (ref: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1411641" target="_blank">Bug 1411641</a>)</p>


  <h2 id="options">Options</h2>

  <h3 id="auto-update-interval">Auto-Update Interval</h3>
  <p>You can set the number of days between updates. Setting 0 (default) means there will be no auto-update.</p>
  <p>In order to minimise the impact on your browsing, auto-update is set to run when Firefox is idle and then 10 updates at a time (until the next idle time).</p>
  <p>Please note that updating each script can take around 4-5 seconds. If there are many scripts, that can add up to consider amount of time. I would suggest manually updating Scripts/CSS or enabling auto-update only on the ones that require regular update.</p>

  <h3 id="global-script-exclude">Global Script Exclude Matches</h3>
  <p>Exclude Match pattens (one per line) to prevent all scripts (not CSS) from running on them.</p>
  <p>Changes to Global Script Exclude Matches will unregister all running script. Once tab is reloaded or on new tab, new settings will take effect.</p>
  <p>Note: Invalid match pattern will cause all scripts to fail and thus get disabled.</p>




  <h3 id="enable-storage">Enable Storage Sync</h3>
  <p>Enable to sync storage if it is under 100KB. If the storage is over 100KB, there will be a notification and the Sync will be turned off automatically to avoid repeated errors.</p>

  <blockquote>For Firefox a user must have Add-ons checked under the "Sync Settings" options in "about:preferences".
  <br><br>
  The main use case of this API is to store preferences about your extension and allow the user to sync them to different profiles. You can store up to 100KB of data using this API. If you try to store more than this, the call will fail with an error message. The API is provided without any guarantees about uptime or performance.

  <cite><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/sync" target="_blank">storage.sync</a></cite>
  </blockquote>

  <h3 id="counter">Counter</h3>
  <p>Enable/Disable Script/CSS counter (Toolbar Iocn Badge & Toolbar Icon Title)</p>

  <h3 id="import-export">Preferences: Import/Export</h3>
  <p>You can export/import Preferences (for backup or share) to/from a local file on your computer. Import is non-destructive. Click save to apply the new settings.</p>

  <h3 id="save">Save</h3>
  <p>Please note that changes will not take effect until they are saved.</p>




  <h2 id="Script-CSS">Script & CSS</h2>
  <p>List of both UserScript and UserCSS</p>
  <p>Scripts and CSS have different icons and the icon for disabled ones are grey.</p>
  <p>Click on the Script/CSS to view/edit/enable/disable/delete or start a new Script/CSS.</p>
  <p><span style="color: #f50;"><b>✘</b></span> shows that there was an error when registering the script. Scripts with errors get disabled automatically.</p>

  <dl>
    <dt>&#x2611; <img src="../image/js.svg" alt=""><img src="../image/css.svg" alt=""></dt>
      <dd>Hide/Show all enabled Script & CSS</dd>

    <dt>&#x2611; <img src="../image/js.svg" style="filter: grayscale(1);" alt=""><img src="../image/css.svg" style="filter: grayscale(1);" alt=""></dt>
      <dd>Hide/Show all disabled Script & CSS</dd>

    <dt>&#x2611; <img src="../image/js.svg" alt=""></dt>
      <dd>Hide/Show all Scripts</dd>

    <dt>&#x2611; <img src="../image/css.svg" alt=""></dt>
      <dd>Hide/Show all CSS</dd>

  </dl>



  <p>The counter shows the number of Script & CSS at the bottom.</p>

  <h3 id="editing">Editing</h3>

    <ul>
      <li><kbd>Tab</kbd> will be converted to 2 spaces. If there is a selection it will be applied to every line in the selection.</li>
      <li><kbd>Tab</kbd> + <kbd>Shift</kbd> will remove 2 spaces (if there are). If there is a selection it will be applied to every line in the selection.</li>
      <li><kbd>Ctrl</kbd> + <kbd>s</kbd> will save the script.</li>
      <li><a href="#syntax-highlighting">Syntax Highlighting</a> refreshes on <code>blur</code> (when you click outside the edit box), & on <code>paste</code>.</li>
    </ul>



  <h4>Navigation Buttons</h4>
  
  <dl>
    <dt>&#x1f4e5; Import</dt>
      <dd>Import one or more Script/CSS from file, same name Script/CSS will be overwritten without warning</dd>

    <dt>&#x1f4e4; Export</dt>
      <dd>Export all Script/CSS to <i>FireMonkey</i> folder in the download location set in <i>Firefox Options -> Downloads</i></dd>

    <dt>&#x1f4e5; Import from Stylus</dt>
      <dd>Export styles from <i>Stylus</i> and Import the JSON (on pop-up change the file type selection to <i>All Files</i>), same name Script/CSS will be overwritten without warning<br>
    Note: Not perfect (but helps), RegEx patterns are ignored, sections are separated into different files (<a href="#stylish-stylus">Stylish/Stylus/xStyle Type UserStyle</a>)</dd>
  </dl>


  <h4>Edit Area Buttons</h4>

  <dl>
    <dt>&#x1f4be; Save</dt>
      <dd>Save the currently displaying Script/CSS</dd>

    <dt>✔ Enable</dt>
      <dd>Enable/Disable the currently displaying Script/CSS</dd>

    <dt>✔ Auto-update</dt>
      <dd>Enable/Disable the Auto-Update on currently displaying Script/CSS</dd>

    <dt>&#x1f310; Update</dt>
      <dd>Update the currently displaying Script/CSS</dd>

    <dt>&#x2795; <img src="../image/js.svg" alt=""></dt>
      <dd>Display a new Script Template that you can edit and Save</dd>

    <dt>&#x2795; <img src="../image/css.svg" alt=""></dt>
      <dd>Display a new CSS Template that you can edit and Save</dd>

    <dt>&#x1f4be; Save Template</dt>
      <dd>Save the currently displaying Script/CSS as a Template</dd>

    <dt>&#x1f4e4; Export</dt>
      <dd>Export the currently displaying Script/CSS to file</dd>

    <dt><img src="../image/bin.svg" alt=""> Delete</dt>
      <dd>Delete the currently displaying Script/CSS after confirmation</dd>

    <dt>Multiple Enable/Disable & Delete</dt>
      <dd>Make a selection of (highlight with mouse) items listed under Script & CSS to multiple Delete (after confirmation) or multiple Enable/Disable the selected items.</dd>
  </dl>



<div style="background-color: #004080"></div>
  <h4><img src="../image/menu-dot.svg" alt=""> Menu</h4>

  <dl>
    <dt>Syntax</dt>
      <dd>Enable/Disable the Syntax Highlighting. Data is saved locally only and not as a preference (not passed to sync).</dd>

    <dt>Dark</dt>
      <dd>Enable/Disable the Dark Theme for the script section only. Data is saved locally only and not as a preference (not passed to sync).</dd>
  </dl>

  <h3 id="syntax-highlighting">Syntax Highlighting</h3>
  <p>Syntax Highlighting requires considerably large libraries. Personally as a developer, I always use a dedicated application for coding and then copy/paste or import into user script/style manager etc. Therefore, for slimness and efficiency, I have written a basic Syntax Highlighting code. It does not have all the features of large library scripts but it is still being improved.</p>
  <p>Although the Syntax Highlighting is fairly fast (took 3.1 seconds for a 3.25mb 69,675 line script), browser takes much longer to render and display the result. Syntax Highlighting can be disabled if wanted.</p>


  <h3 id="self-update">Self-Update</h3>
  <p>For users that edit scripts regularly, a proper editor is more convenient. You can then update the installed version by:</p>
  <ul>
    <li>Copy & Paste directly into the script Editor</li>
    <li>Import from Navigation Buttons</li>
    <li>Drag & Drop to a tab (or open in tab) and confirm to install. In case of repeated edit, you can keep the tab open and refresh and confirm to update the old one.</li>
  </ul>

  <h3 id="auto-update">Update & Auto-Update</h3>
  <p>Any target can be set for <code>@updateURL</code> as long it directly leads to the final file and it is in plain text. The <code>.js</code> or <code>.css</code> file extensions are not necessary although it makes sense to have them. The <code>.user.</code> is not necessary.</p>
  <p><i>FireMonkey</i> uses <code>@version</code> for the update process and both the current file and the update file must have <code>@version</code> and the version of the target file must be higher.</p>
  <p>In case of <i>GreasyFork</i> & <i>OpenUserJS</i>, the <code>@version</code> via Metadata Block in <code>https://...../*.meta.js</code> is verified first.</p>
  <p>Update will fail if the new version has a different name which already exists among user's installed Scripts/CSS.</p>
  <p>Auto-update will only update enabled Scripts/CSS but manual update can update both enabled and disabled ones.</p>
  <p><code>@downloadURL/@installURL</code>, if present, is set for script update.</p>

<table>
  <caption>Comparison</caption>
  <thead>
  <tr>
    <th>Manager</th>
    <th>@updateURL</th>
    <th>@downloadURL</th>
    <th>install source</th>
    <th>meta.js</th>
    <th>meta.css</th>
    <th>last-modified header</th>
  </tr>
  </thead>
  <tbody>
  <tr><th>FireMonkey</th><td>update target</td><td>sets updateURL</td><td>GreasyFork/OpenUserJS</td><td class="pass"></td><td class="pass"></td><td class="fail"></td></tr>
  <tr><th>GreaseMonkey</th><td class="fail"></td><td class="fail"></td><td class="fail"></td><td>update target <a href="https://github.com/greasemonkey/greasemonkey/issues/3057" title="Auto-Update Scripts" target="_blank">[*]</a></td><td class="fail"></td><td class="fail"></td></tr>
  <tr><th>TamperMonkey</th><td>JSON</td><td>update target</td><td class="unknown"></td><td class="pass"></td><td class="fail"></td><td class="unknown"></td></tr>
  <tr><th>ViolentMonkey</th><td class="fail"></td><td>update target <a href="https://violentmonkey.github.io/api/metadata-block/#downloadurl" title="Metadata Block @downloadURL" target="_blank">[*]</a></td><td>update target <a href="https://violentmonkey.github.io/api/metadata-block/#downloadurl" title="Automatically added when using 'Install from URL.'" target="_blank">[*]</a></td><td class="pass"></td><td class="fail"></td><td class="unknown"></td></tr>

  <tr>
    <th><b>Repository</b></th>
    <td colspan="6"></td>
  </tr>

  <tr><th>GreasyFork</th><td class="fail"><a href="https://greasyfork.org/en/help/meta-keys" title="@updateURL, @installURL, @downloadURL: Describe how user script managers should get updates. Greasy Fork will strip these keys, which makes any script installed from Greasy Fork only update from Greasy Fork." target="_blank">[*]</a></td><td class="fail"></td><td></td><td class="pass"></td><td class="pass"></td><td class="fail"></td></tr>
  <tr><th>GitHub/Gist</th><td class="fail"></td><td class="fail"></td><td></td><td class="fail"></td><td class="fail"></td><td class="fail"></td></tr>
  <tr><th>OpenUserJS</th><td class="pass"></td><td class="pass"></td><td></td><td class="pass"></td><td class="pass"></td><td class="fail"></td></tr>
  </tbody>
</table>


  <h3 id="user-matches-exclude"><img src="../image/menu.svg" alt=""> User Matches & Exclude Matches</h3>
  <p>Persistent user matches & excludeMatches (one per line using Match Patterns) can be set for each script to supplement script's matches & excludeMatches.</p>
  <p>Please note that invalid match pattern will cause the script to fail and thus get disabled.</p>



  <h2 id="metadata-block">Metadata Block</h2>
  <p>For easier compatibility, format is similar to <i>GreaseMonkey</i> Metadata Block for UserScripts. The commenting is different for CSS and as a result a uniform commenting for Metadata Block can be used. The Metadata Block identifier (case-insensitive e.g. ==userscript== etc) for UserScript is <code>==UserScript== ... ==/UserScript==</code> and for UserCSS is <code>==UserCSS== ... ==/UserCSS==</code>. For clarity, it is best to have the Metadata Block on top (or after <code>'use strict';</code> if wanted, but <i>FireMonkey</i> can pick it up from anywhere within the code.</p>
  <p>Note: Read <a href="#stylish-stylus">Stylish/Stylus/xStyle Type UserStyle</a> for <code>==UserStyle== ... ==/UserStyle==</code></p>

   <figure>
    <figcaption>JS Single-line Comment</figcaption>
<pre class="comment">
// ==UserScript==
// @name            My Script
// @description     Scripting is fun
// @match           http://www.example.com/*
// @match           http://www.example.org/*
// @version         1.0
// ==/UserScript==
</pre>
  </figure>

  <figure>
    <figcaption>JS Multi-line Comment</figcaption>
<pre class="comment">
/*
==UserScript==
@name               My Script
@description        Scripting is fun
@match              http://www.example.com/*
@match              http://www.example.org/*
@version            1.0
==/UserScript==
*/
</pre>
  </figure>

  <figure>
    <figcaption>CSS Multi-line Comment</figcaption>
<pre class="comment">
/*
==UserCSS==
@name               My CSS
@description        CSS is fun
@match              http://www.example.com/*
@match              http://www.example.org/*
@version            1.0
==/UserCSS==
*/
</pre>
  </figure>




  <p><i>FireMonkey</i> supports the following entries based on <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/contentScripts/register" target="_blank">
contentScripts.register()</a> & <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/userScripts/register" target="_blank">
userScripts.register()</a>. Each entry must be in the format of <code>@entry ...some space ... detail</code>. In case of matches & globes, repeat entry for each detail. Match details must conform to the <b>Match Patterns</b>.</p>
  <p>Script/CSS developers are free to add any other <i>@entry</i> (e.g. <i>@homepage, @copyright, @support</i> etc) for reference or information.</p>

  <p><b>Note:</b> <i>FireMonkey</i> uses the <code>name</code> (case-sensitive) as ID for Scripts & CSS, therefore names must be unique. A shorter & concise name is recommended.</p>


  <figure>
    <figcaption>Metadata Block</figcaption>
<pre class="comment">
@name
@matches
@version            <i>(needed for updates)</i>
@updateURL          <i>(needed for updates)</i>

@author
@description
@excludeMatches
@includeGlobs
@excludeGlobs
@allFrames          <i>(true or false (default))</i>
@matchAboutBlank    <i>(true or false (default))</i>
@run-at             <i>(document_start or document_end or document_idle (default))</i>

@require            <i>(script-name, specific-library, other-URL)</i>
@resource           <i>resourceName resourceURL</i>

@match              <i>(entries will be merged into matches)</i>
@include            <i>(entries will be merged into matches, use match, matches or includeGlobs instead)</i>
@exclude            <i>(entries will be merged into excludeMatches)</i>
@exclude-match      <i>(entries will be merged into excludeMatches)</i>
@noframes           <i>(if present will set @allFrames to false (default))</i>
</pre>
  </figure>

  <h4>matchAboutBlank</h4>
  <p>The code cannot be inserted in top-level <code>about:</code> frames.</p>

  <blockquote>Insert the content scripts into pages whose URL is <code>"about:blank"</code> or <code>"about:srcdoc"</code>, if the URL of the page that opened or created this page <a href="https://developer.mozilla.org/Add-ons/WebExtensions/manifest.json/content_scripts#Matching_URL_patterns" target="_blank">matches the patterns</a> specified in the rest of the <code>content_scripts</code> key.<br><br>

  This is especially useful to run scripts in empty iframes , whose URL is <code>"about:blank"</code>. To do this you should also set the <code>all_frames</code> key.<br><br>

  For example, suppose you have a <code>content_scripts</code> key like this:<br>

<pre>
"content_scripts": [
  {
    "js": ["my-script.js"],
    "matches": ["https://example.org/"],
    "match_about_blank": true,
    "all_frames": true
  }
]
</pre>

  If the user loads <code>https://example.org/</code>, and this page embeds an empty iframe, then <code>"my-script.js"</code> will be loaded into the iframe.
  
  <cite><a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts" target="_blank">content_scripts</a></cite></blockquote>

  <blockquote><b>matchAboutBlank</b> <i>Optional</i><br><br>

    <code>boolean</code>. If <code>true</code>, the code will be injected into embedded <code>about:blank</code> and <code>about:srcdoc</code> frames if your extension has access to their parent document. The code cannot be inserted in top-level <code>about:</code> frames.

    Defaults to <code>false</code>.
  <cite><a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript" target="_blank">tabs.executeScript()</a></cite></blockquote>

  <h4>run-at</h4>
  <p><i>FireMonkey</i> default <code>run-at</code> is <code>document_idle</code>, therefore there is no need for event listeners such as <code>'load'</code> or <code>'DOMContentLoaded'</code> as they will not apply. If script has to run earlier, then the <code>run-at</code> has to be set accordingly.</p>
  <p><i>GreaseMonkey</i> uses hyphen separated words (<code>document-start|document-end|document-idle</code>), while the API uses underscore separated words (<code>document_start|document_end|document_idle</code>). <i>FireMonkey</i> converts the hyphen so both can be used.</p>

  <p><i>FireMonkey</i> accepts both GM style <code>run-at</code> and browser API style <code>runAt</code>.</p>

  <p><b>N.B.</b> CSS mangers like Stylus tend to inject CSS at <code>document-start</code>. The benefit of <code>document-start</code> for CSS is that the changes will display earlier. The drawback is that the page CSS may override these CSS and if so, it is better to inject later at <code>document-end</code> or <code>document-idle</code>.</p>

  <dl>
    <dt>document_start</dt>
      <dd>Corresponds to <code>loading</code>. The DOM is still loading.</dd>
      
    <dt>document_end</dt>
      <dd>Corresponds to <code>interactive</code>. The DOM has finished loading, but resources such as scripts and images may still be loading.</dd>
      
    <dt>document_idle</dt>
      <dd>Corresponds to <code>complete</code>. The document and all its resources have finished loading.</dd>
  </dl>

  <h4>defaults</h4>
  <p><i>FireMonkey</i> conforms to the Firefox (& Chrome) <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts" target="_blank">content_scripts</a> API defaults.</p>

<table>
  <caption>Default Comparison</caption>
  <thead>
  <tr>
    <th>Manager</th>
    <th>run-at</th>
    <th>allFrames</th>
    <th>matchAboutBlank</th>
  </tr>
  </thead>
  <tbody>
  <tr><th>FireMonkey</th><td>document-idle</td><td>false</td><td>false</td></tr>
  <tr><th>GreaseMonkey</th><td>document-end</td><td>true</td><td>via @include &nbsp;&nbsp;&nbsp;about:blank</td></tr>
  <tr><th>TamperMonkey</th><td>document-idle</td><td>true</td><td class="unknown"></td></tr>
  <tr><th>ViolentMonkey</th><td>document-end</td><td>true</td><td class="unknown"></td></tr>
  </tbody>
</table>



  <h4>include/exclude</h4>
  <p>Entries under <code>@include/@exclude</code> will be merged into <code>@matches/@excludeMatches</code> (duplicates removed). Some common incompatibilities with <code>matches</code> API are automatically converted.</p>

<table>
  <caption>Conversation Examples</caption>
  <thead>
  <tr>
    <th>From include</th>
    <th>To match</th>
  </tr>
  </thead>
  <tbody>
  <tr><td><code>*</code></td><td><code>*://*/*</code></td></tr>
  <tr><td><code>http://*</code></td><td><code>http://*/*</code></td></tr>
  <tr><td><code>https://*</code></td><td><code>https://*/*</code></td></tr>
  <tr><td><code>http*://*</code></td><td><code>*://*/*</code></td></tr>
  <tr><td><code>http*://a.b.c/*</code></td><td><code>*://a.b.c/*</code></td></tr>
  <tr><td><code>*://google.*<br>http*://www.google.*</code></td><td><code>*://*.google.TLD/*</code></td></tr>
  <tr><td><code>*.example.com/*</code></td><td><code>*://*.example.com/*</code></td></tr>
  </tbody>
</table>




  <h3 id="match-patterns">Match Patterns</h3>
  <p><i>FireMonkey</i> uses <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/match_patterns" target="_blank">Match Patterns</a> for <code>@matches/@match</code> & <code>@excludeMatches</code> and <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts#globs" target="_blank">globs</a> for <code>@includeGlobs</code> & <code>@excludeGlobs</code></p>
  <p>Note: Paths are case-sensitive.</p>

  <p>A <b>glob</b> is just a string that may contain wildcards. There are two types of wildcard, and you can combine them in the same glob:</p>

    <ul>
      <li>Wildcard <strong>*</strong> matches zero or more characters</li>
      <li>Character <strong>?</strong> matches exactly one character</li>
    </ul>

<p>For example: <code>"*na?i"</code> would match <code>"illuminati"</code> and <code>"annunaki"</code>, but not <code>"sagnarelli"</code>.</p>

<table>
  <caption>Examples</caption>
  <thead>
  <tr>
    <th>Pattern</th>
    <th>match</th>
    <th>no-match</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>
      <code>&lt;all_urls&gt;</code>
      <p>Match all URLs</p>
    </td>
    <td>
      <p class="pass">http://example.org/</p>
      <p class="pass">https://files.example.org/</p>
      <p class="pass"><s>ftp://example.org/some/path/</s> <a href="#ftp" title="What to expect for the upcoming deprecation of FTP in Firefox">[*]</a></p>
    </td>
    <td>
    </td>
  </tr>

  <tr>
    <td>
      <code>*://*/*</code>
      <p>Match all HTTP, HTTPS</p>
    </td>
    <td>
      <p class="pass">http://example.org/</p>
      <p class="pass">https://www.example.org/aaa/</p>

    </td>
    <td>
      <p class="fail"><s>ftp://www.example.org/aaa/</s></p>
    </td>
  </tr>

  <tr>
    <td>
      <code>*://*.example.org/*</code>
    </td>
    <td>
      <p class="pass">http://example.org/</p>
      <p class="pass">https://www.example.org/</p>
      <p class="pass">http://www.sub.example.org/aaa/</p>
    </td>
    <td>
    </td>
  </tr>

  <tr>
    <td>
      <code>*://example.org/</code>
    </td>
    <td>
      <p class="pass">http://example.org/</p>


    </td>
    <td>
      <p class="fail">https://www.example.org/</p>
      <p class="fail">http://example.org/aaa/</p>
    </td>
  </tr>

  <tr>
    <td>
      <code>https://*/path</code>
    </td>
    <td>

      <p class="pass">https://www.example.org/path</p>
    </td>
    <td>
      <p class="fail">http://example.org/</p>
      <p class="fail">http://example.org/path</p>
    </td>
  </tr>

  <tr>
    <td>
      <code>file:///blah/*</code>
    </td>
    <td>
      <p class="pass">file:///blah/</p>
      <p class="pass">file:///blah/bleh</p>
    </td>
    <td>
      <p class="fail">file:///bleh/</p>
    </td>
  </tr>
  </tbody>
</table>

<table>
    <caption>Invalid Match Patterns</caption>
  <thead>
  <tr>
    <th>Invalid Pattern</th>
    <th>Reason</th>
  </tr>
  </thead>
  <tbody>
  <tr><td><code class="fail">resource://path/</code></td><td>Unsupported scheme</td></tr>
  <tr><td><code class="fail">https://mozilla.org</code></td><td>No path</td></tr>
  <tr><td><code class="fail">https://mozilla.*.org/</code></td><td><code>"*"</code> in host must be at the start</td></tr>
  <tr><td><code class="fail">https://*zilla.org/</code></td><td><code>"*"</code> in host must be the only character or be followed by <code>"."</code></td></tr>
  <tr><td><code class="fail">http*://mozilla.org/</code></td><td><code>"*"</code> in scheme must be the only character</td></tr>
  <tr><td><code class="fail">https://mozilla.org:80/</code></td><td>Host must not include a port number</td></tr>
  <tr><td><code class="fail">*://*</code></td><td>Empty path: this should be <code>"*://*/*"</code></td></tr>
  <tr><td><code class="fail">file://*</code></td><td>Empty path: this should be <code>"file:///*"</code></td></tr>
  </tbody>
</table>




  <p><b>Note:</b> Content scripts are blocked by Firefox on the following domains:</p>

  <ul style="columns: 2;">
    <li>accounts-static.cdn.mozilla.net</li>
    <li>accounts.firefox.com</li>
    <li>addons.cdn.mozilla.net</li>
    <li>addons.mozilla.org</li>
    <li>api.accounts.firefox.com</li>
    <li>content.cdn.mozilla.net</li>
    <li>content.cdn.mozilla.net</li>
    <li>discovery.addons.mozilla.org</li>
    <li>input.mozilla.org</li>
    <li>install.mozilla.org</li>
    <li>oauth.accounts.firefox.com</li>
    <li>profile.accounts.firefox.com</li>
    <li>support.mozilla.org</li>
    <li>sync.services.mozilla.com</li>
    <li>testpilot.firefox.com</li>
  </ul>


  <h4>includeGlobs & excludeGlobs</h4>
  <p>Due to the following logic process in Firefox & Chrome, when using <code>includeGlobs</code>, there must also be the mandatory <code>matches</code> (or <code>match</code>).</p>
    
  <blockquote>Since <code>matches</code> is the only mandatory key, the other three keys are used to limit further the URLs that match. To match the key as a whole, a URL must:

    <ul>
      <li>match the <code>matches</code> property</li>
      <li>AND match the <code>include_globs</code> property, if present</li>
      <li>AND NOT match the <code>exclude_matches</code> property, if present</li>
      <li>AND NOT match the <code>exclude_globs</code> property, if present</li>
    </ul>

  <cite><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts" target="_blank">content_scripts</a></cite></blockquote>

  <figure>
    <figcaption>Example with includeGlobs</figcaption>
<pre><span class="comment">/*
==UserCSS==
@name               My CSS
@description        CSS is fun
@match              *://*/*
@includeGlobs       http://www.example.*/*
@version            1.0
==/UserCSS==
*/
  </pre>
  </figure>

<h3 id="ftp">FTP &#x26a0;&#xfe0f;</h3>

  <blockquote>The Firefox platform development team recently <a href="https://groups.google.com/forum/#!msg/mozilla.dev.platform/FqCZUT9ay_o/jt4DLRDjAwAJ">announced plans</a> to first disable, and then remove the implementation for built-in <a href="https://developer.mozilla.org/en-US/docs/Glossary/FTP">FTP</a> from the browser.
  
  <cite><a href="https://blog.mozilla.org/addons/2020/04/13/what-to-expect-for-the-upcoming-deprecation-of-ftp-in-firefox/" target="_blank">What to expect for the upcoming deprecation of FTP in Firefox</a></cite></blockquote>


  <h3 id="tld">TLD</h3>
  <p>A TLD (case-insensitive) wildcard can be used and <i>FireMonkey</i> will automatically generate a list of most common country TLD <code>@matches</code>. Due to the extra Firefox API processing for many <code>@matches</code>, it is best to use it only when necessary.</p>


  <figure>
    <figcaption>*://*.example.TLD/* <span>(general use)</span></figcaption>
<pre class="gm" style="columns: 6;">
.com
.au
.br
.ca
.ch
.cn
.co.uk
.de
.es
.fr
.in
.it
.jp
.mx
.nl
.no
.pl
.ru
.se
.uk
.us
</pre>
  </figure>

  <figure>
    <figcaption>.amazon.TLD <span>(domain specific)</span></figcaption>
<pre class="gm" style="columns: 6;">
.ca
.cn
.co.jp
.co.uk
.com
.com.au
.com.br
.com.mx
.com.sg
.com.tr
.de
.es
.fr
.in
.it
.nl
</pre>
  </figure>

  <figure>
    <figcaption>.ebay.TLD <span>(domain specific)</span></figcaption>
<pre class="gm" style="columns: 6;">
.at
.be
.ca
.ch
.cn
.co.th
.co.uk
.com.au
.com.cn
.com.hk
.com.my
.com.sg
.com.tw
.com
.de
.dk
.es
.fi
.fr
.gr
.hu
.ie
.in
.it
.nl
.no
.ph
.ph
.pl
.ru
.vn
</pre>
  </figure>

  <figure>
    <figcaption>.google.TLD <span>(domain specific)</span></figcaption>
  <div class="scroll">
<pre class="gm" style="columns: 6;">
.ae
.al
.am
.as
.at
.az
.ba
.be
.bf
.bg
.bi
.bj
.bs
.bt
.by
.ca
.cat
.cd
.cf
.cg
.ch
.ci
.cl
.cm
.cn
.co.ao
.co.bw
.co.ck
.co.cr
.co.id
.co.il
.co.in
.co.jp
.co.ke
.co.kr
.co.ls
.co.ma
.co.mz
.co.nz
.co.th
.co.tz
.co.ug
.co.uk
.co.uz
.co.ve
.co.vi
.co.za
.co.zm
.co.zw
.com
.com.af
.com.ag
.com.ai
.com.ar
.com.au
.com.bd
.com.bh
.com.bn
.com.bo
.com.br
.com.bz
.com.co
.com.cu
.com.cy
.com.do
.com.ec
.com.eg
.com.et
.com.fj
.com.gh
.com.gi
.com.gt
.com.hk
.com.jm
.com.kh
.com.kw
.com.lb
.com.ly
.com.mm
.com.mt
.com.mx
.com.my
.com.na
.com.nf
.com.ng
.com.ni
.com.np
.com.om
.com.pa
.com.pe
.com.pg
.com.ph
.com.pk
.com.pr
.com.py
.com.qa
.com.sa
.com.sb
.com.sg
.com.sl
.com.sv
.com.tj
.com.tr
.com.tw
.com.ua
.com.uy
.com.vc
.com.vn
.cv
.cz
.de
.dj
.dk
.dm
.dz
.ee
.es
.fi
.fm
.fr
.ga
.ge
.gg
.gl
.gm
.gp
.gr
.gy
.hn
.hr
.ht
.hu
.ie
.im
.iq
.is
.it
.je
.jo
.kg
.ki
.kz
.la
.li
.lk
.lt
.lu
.lv
.md
.me
.mg
.mk
.ml
.mn
.ms
.mu
.mv
.mw
.ne
.ng
.nl
.no
.nr
.nu
.pl
.pn
.ps
.pt
.ro
.rs
.ru
.rw
.sc
.se
.sh
.si
.sk
.sm
.sn
.so
.sr
.st
.td
.tg
.tk
.tl
.tm
.tn
.to
.tt
.vg
.vu
.ws
</pre>
</div>
  </figure>

  <h3 id="require">require</h3>
  <p>The API is added for convenience and compatibility but it works differently in comparison to other script managers.</p>
  <p>You can use <code>@require</code> for both scripts and CSS but it will be added as the same type i.e. <code>@require</code> in scripts will be injected as JavaScript and require in CSS will be injected as CSS.</p>


  <h4>require &nbsp;&nbsp;&nbsp; script-name</h4>
  <p><code>@require</code> can be used to pre-include other existing scripts into a script (or other existing CSS into a CSS). For example:</p>
<pre class="comment">
@require            My Script
</pre>
    <p>For example, user/developer can save some code as a script and name it <code>HelperSet</code>. It does not need to have <code>match/matches/include/includeGlobs</code> etc. It is best to keep the script DISABLED (not enabled) e.g.:</p>

  <figure>
    <figcaption>Script Example</figcaption>
<pre><span class="comment">// ==UserScript==
// @name            HelperSet
// @description     A set of helper functions
// @version         1.0
// ==/UserScript==</span>

<span class="keyword">function</span> someFunc(id) {

  <span class="comment">// some code </span>
}

<span class="keyword">function</span> otherFunc(text) {

  <span class="comment">// some code </span>
}</pre>
  </figure>


  <figure>
    <figcaption>Include in Other Scripts</figcaption>
<pre class="comment">// ==UserScript==
// @name            My Script
// @description     Scripting is fun
// @match           http://www.example.com/*
// @match           http://www.example.org/*
// @version         1.0
// @require         HelperSet
// ==/UserScript==

..... code .....</pre>
  </figure>


  <figure>
    <figcaption>Multiple require <span>(injected in order)</span></figcaption>
<pre class="comment">
// @require         jquery-3
// @require         HelperSet
</pre>
  </figure>

  <figure>
    <figcaption>CSS require</figcaption>
<pre class="comment">/*
==UserCSS==
@name               My CSS
@description        CSS is fun
@match              http://www.example.com/*
@match              http://www.example.org/*
@version            1.0
@require            DefaultCSS
==/UserCSS==
*/</pre>
  </figure>

  <h4>require &nbsp;&nbsp;&nbsp; specific-library</h4>
  <p>Few libraries have been packed with <i>FireMonkey</i> which will be injected for user-scripts using <code>@require</code>. A shorthand (case-insensitive) can also be used.</p>
  <p>Based on data provided by <i>GreasyFork</i>, 8,011/31,170 (26%) use <code>@require</code> and from those 7,082/11,236 (63%) entries relate to these libraries (& <i>gm4-polyfill</i>).</p>

  <p>Folowing CDN sources are processed:</p>

  <ul style="columns: 2;">
    <li>ajax.aspnetcdn.com</li>
    <li>ajax.googleapis.com</li>
    <li>apps.bdimg.com</li>
    <li>cdn.bootcss.com</li>
    <li>cdn.jsdelivr.net</li>
    <li>cdn.staticfile.org</li>
    <li>cdnjs.cloudflare.com</li>
    <li>code.jquery.com</li>
    <li>lib.baomitu.com</li>
    <li>libs.baidu.com</li>
    <li>pagecdn.io</li>
    <li>unpkg.com</li>
  </ul>


<table>
  <caption>Bundled Libraries</caption>
  <thead>
  <tr>
    <th>CDN Links to</th>
    <th>Shorthand</th>
    <th>Injected Library Version</th>
  </tr>
  </thead>
  <tbody>
  <tr><td>bootstrap</td><td>bootstrap-4</td><td>4.5.0</td></tr>
  <tr><td>jquery 1.*</td><td>jquery-1</td><td>1.12.4</td></tr>
  <tr><td>jquery 2.*</td><td>jquery-2</td><td>2.2.4</td></tr>
  <tr><td>jquery 3.*</td><td>jquery-3</td><td>3.5.1</td></tr>
  <tr><td>jquery-ui 1.*</td><td>jquery-ui-1</td><td>1.12.1</td></tr>
  <tr><td>moment</td><td>moment-2</td><td>2.27.0</td></tr>
  <tr><td>underscore</td><td>underscore-1</td><td>1.10.2</td></tr>

  </tbody>
</table>


  <figure>
    <figcaption>Example</figcaption>
<pre class="comment">
// @require         jquery-3
// @require         https://code.jquery.com/jquery-3.5.1.js
// @require         https://code.jquery.com/jquery-3.4.1.min.js
// @require         https://code.jquery.com/jquery-3.*.*.slim.js
// @require         https://code.jquery.com/jquery-3.*.*.slim.min.js
// @require         https://ajax.googleapis.com/ajax/libs/jquery/3.*.*/jquery.js
  ... etc
// @require         https://unpkg.com/jquery@3.*.*/dist/jquery.js
  ... etc
</pre>
</figure>


  <p>On popular demand, more libraries may be added in future.</p>

  <h4>require &nbsp;&nbsp;&nbsp; other-URL &#x26a0;&#xfe0f;</h4>
  <p>The API is added for convenience and compatibility but it works differently in comparison to other script managers as the target is not not stored. It uses <code>fetch()</code> to get the target the first time but on subsequently <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request/cache" target="_blank">Request.cache</a> will be used by the browser. Please note:</p>
  <ul>
    <li>Processing many scripts with many <code>@require</code> can take time when registering scripts (i.e. browser start-up, disabling & re-enabling <i>FireMonkey</i>)</li>
    <li><i>gm4-polyfill</i> is not applicable (and may cause conflict) and therefore is not processed</li>
  </ul>



  <h3 id="storing-require-resource">Storing require & resource Targets &#x26d4;</h3>
  <p>In legacy Firefox, extensions were able to save files to their folder in Firefox profile. Script managers would download <code>@require</code> & <code>@resource</code> targets, save it to users' HD and inject it when called.</p>

  <p>Firefox Quantum no longer allows extension to save fies to Fireofx profile folder. Script managers will have to use the storage assigned to the extension to save <code>@require</code> & <code>@resource</code> files in form of data.</p>

  <p>Saving large volume of data to storage impact RAM and CPU resource usage of the extension, slows down read/write to the extension storage and generally impact the browser performance. Known Libraries often are 100+KB to 1+MB e.g. <i>jquery-3.4.1.js 273MB,jquery-3.4.1.min.js 86KB, jquery-ui-1.12.1.js 508KB, jquery-ui-1.12.1.min.js 247KB, angular-1.7.6.js 1.3MB</i> ... etc. In case of <code>@resource</code>, images for example could be many megabytes of data.</p>

  <p>Considering that a user may have many user-Scripts and they may have many <code>@require</code> & <code>@resource</code>, the size of storage can get extremely large and its effect on browser performance quite considerable.</p>

  <figure>
    <figcaption>getResourceUrl Alternative for CSS</figcaption>
<pre>
<span class="comment">// ==UserScript==
// @name            GM.getResourceUrl test
// @description     GM.getResourceUrl() API method
// @resource        CSS http://www.example.com/example.css
// ==/UserScript==</span>


<code class="deprecated"><span class="comment">// instead of this code</span>
(<span class="keyword">async</span> () =&gt; {
  <span class="keyword">const</span> link = document.<span class="method">createElement</span>(<span class="string">'link'</span>);
  link.<span class="property">href</span> = <span class="keyword">await</span> <span class="gm">GM.getResourceUrl</span>(<span class="string">'CSS'</span>);
  link.rel = <span class="string">'stylesheet'</span>;
  document.<span class="property">body</span>.<span class="method">appendChild</span>(<span class="property">style</span>);
})();</code>
<code><span class="comment">// you can use this one</span>
<span class="keyword">const</span> link = document.<span class="method">createElement</span>(<span class="string">'link'</span>);
link.<span class="property">href</span> = <span class="string">'http://www.example.com/example.css'</span>;
link.rel = <span class="string">'stylesheet'</span>;
document.<span class="property">head</span>.<span class="method">appendChild</span>(link);</code></pre>
  </figure>

  <figure>
    <figcaption>getResourceUrl Alternative for image</figcaption>
<pre><span class="comment">// ==UserScript==
// @name            GM.getResourceUrl test
// @description     GM.getResourceUrl() API method
// @resource        logo http://www.example.com/logo.jpg
// ==/UserScript==</span>


<code class="deprecated"><span class="comment">// instead of this code</span>
(<span class="keyword">async</span> () =&gt; {
  <span class="keyword">const</span> img = document.<span class="method">createElement</span>(<span class="string">'img'</span>);
  img.<span class="property">src</span> = <span class="keyword">await</span> <span class="gm">GM.getResourceUrl</span>(<span class="string">'logo'</span>);
  document.<span class="property">body</span>.<span class="method">appendChild</span>(<span class="property">img</span>);
})();</code>
<code><span class="comment">// you can use this one</span>
<span class="keyword">const</span> img = document.<span class="method">createElement</span>(<span class="string">'img'</span>);
img.<span class="property">src</span> = <span class="string">'http://www.example.com/logo.jpg'</span>;
document.<span class="property">head</span>.<span class="method">appendChild</span>(img);</code></pre>
  </figure>


  <h3 id="grant">grant &#x26d4;</h3>
  <p>Scripts will have access to all available APIs and therefore <code>@grant</code> is not needed or used.</p>

  <h2 id="script-api"><img src="../image/js.svg" alt=""> Script API</h2>
  <p><i>FireMonkey</i> supports both GM4 & GM3 style APIs (e.g. GM.*** & GM_***) via mostly asynchronous <code>Promise</code>. Therefore if scripts requires a <code>return</code>, it must wait for the <code>Promise</code> to resolve.</p>
  <p>Following APIs (similar to <i>GreaseMonkey</i>) are provided to the user scripts (<i>more may be added later</i>)</p>

  <figure>
    <figcaption>API Examples</figcaption>
<pre>(<span class="keyword">async</span> () =&gt; {
<span class="string">'use strict'</span>;

  <span class="comment">// ----- Promise</span>

  <span class="comment">// stored value for key OR default</span>
  <span class="keyword">const</span> <span class="property">value</span> = <span class="keyword">await</span> <span class="gm">GM.getValue</span>(key, default);
  <span class="keyword">const</span> <span class="property">value</span> = <span class="keyword">await</span> <span class="gm">GM_getValue</span>(key, default);

  <span class="comment">// an array of keys set by script OR []</span>
  <span class="keyword">const</span> <span class="method">keys</span> = <span class="keyword">await</span> <span class="gm">GM.listValues</span>();
  <span class="keyword">const</span> <span class="method">keys</span> = <span class="keyword">await</span> <span class="gm">GM_listValues</span>();

  <span class="comment">// Response Object</span>
  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="gm">GM.fetch</span>(url[, init]);
  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="gm">GM_fetch</span>(url[, init]);

  <span class="comment">// Response Text</span>
  <span class="keyword">const</span> text = <span class="keyword">await</span> <span class="gm">GM.getResourceText</span>(resourceName);
  <span class="keyword">const</span> text = <span class="keyword">await</span> <span class="gm">GM_getResourceText</span>(resourceName);



  <span class="comment">// ----- Callback Function</span>

  <span class="gm">GM.xmlHttpRequest</span>({
    url: <span class="string">'https://example.com/etc'</span>,
    <span class="property">onload</span>: response =&gt; {
      <span class="property">console</span>.<span class="method">log</span>(response.<span class="property">responseText</span>);
    }
  });


  <span class="comment">// note: listenerId = key (not necessary in FireMonkey)</span>
  <span class="keyword">const</span> listenerId = <span class="gm">GM.addValueChangeListener</span>(key, callback);

  <span class="gm">GM.addValueChangeListener</span>(key, callback)
  <span class="gm">GM_addValueChangeListener</span>(key, callback)


  <span class="comment">// ----- usually there is no need to wait for the following, but if needed, use await</span>

  <span class="gm">GM.setValue</span>(key, <span class="property">value</span>)
  <span class="gm">GM_setValue</span>(key, <span class="property">value</span>)

  <span class="gm">GM.deleteValue</span>(key)
  <span class="gm">GM_deleteValue</span>(key)

  <span class="gm">GM.openInTab</span>(url, open_in_background)
  <span class="gm">GM_openInTab</span>(url, open_in_background)

  <span class="gm">GM.setClipboard</span>(text)
  <span class="gm">GM_setClipboard</span>(text)

  <span class="gm">GM.notification</span>(text)
  <span class="gm">GM_notification</span>({text: '...', image: '...', ....})

  <span class="gm">GM.download</span>(url, fielname)
  <span class="gm">GM_download</span>(url, fielname)


  <span class="comment">// ----- Synchronous Functions</span>

  <span class="gm">GM.addStyle</span>(css)
  <span class="gm">GM_addStyle</span>(css)

  <span class="gm">GM.getResourceUrl</span>(resourceName)
  <span class="gm">GM_getResourceUrl</span>(resourceName)

  <span class="gm">GM.registerMenuCommand</span>(name, onclick)
  <span class="gm">GM_registerMenuCommand</span>(name, onclick)

  <span class="gm">GM.unregisterMenuCommand</span>(name)
  <span class="gm">GM_unregisterMenuCommand</span>(name)

  <span class="gm">GM.removeValueChangeListener</span>(key)
  <span class="gm">GM_removeValueChangeListener</span>(key)

  <span class="gm">GM.log</span>(text [, text2, ..., textN])
  <span class="gm">GM_log</span>(text [, text2, ..., textN])

  <span class="gm">GM.info</span>
  <span class="gm">GM_info</span>

  <span class="gm">unsafeWindow</span>
})();</pre>
</figure>


  <h3 id="fetch">fetch</h3>
  <p><i>FireMonkey</i> <code>fetch</code> API is based on the JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch" target="_blank">Fetch API</a> which provides the new Promise based interface for fetching resources (including across the network). It will seem familiar to anyone who has used <code>XMLHttpRequest</code>, but it provides a more powerful and flexible feature set.</p>
  <p>For simplicity and compatibility, the same GM style naming is kept for <code>fetch</code> API although it is not available in <i>GreaseMonkey</i>.</p>
  <p><i>FireMonkey</i> <code>fetch</code> returns response object/string or <code>null</code> (check console for errors e.g.: <i>TypeError: "NetworkError when attempting to fetch resource.</i>").</p>


<pre>GM.fetch(url[, init]);
GM_fetch(url[, init]);</pre>

    <h4>url</h4>
    <p>http, https, <s>ftp, ftps</s> <a href="#ftp" title="What to expect for the upcoming deprecation of FTP in Firefox">[*]</a>, (file not allowed), can be relative to the web page</p>

    <h4>init <span>(Optional)</span></h4>
    <p>An options object containing any custom settings that you want to apply to the request. The possible options are:</p>

    <ul>
      <li><code>method:</code> The request method, e.g., GET, POST. (can be omitted, defaults to 'GET')</li>
      <li><code>headers:</code> Any headers you want to add to your request, contained within a Headers object or an object literal with ByteString values.</li>
      <li><code>body:</code> Any body that you want to add to your request: this can be a Blob, BufferSource, FormData, URLSearchParams, or USVString object. Note that a request using the GET or HEAD method cannot have a body.</li>
      <li><code>mode:</code> The mode you want to use for the request, e.g., cors, no-cors, or same-origin.</li>
      <li><code>credentials:</code> The request credentials you want to use for the request: omit, same-origin, or include. To automatically send cookies for the current domain, this option must be provided. Starting with Chrome 50, this property also takes a FederatedCredential instance or a PasswordCredential instance.</li>
      <li><code>cache:</code> The cache mode you want to use for the request.</li>
      <li><code>redirect:</code> The redirect mode to use: follow (automatically follow redirects), error (abort with an error if a redirect occurs), or manual (handle redirects manually). In Chrome the default is follow (before Chrome 47 it defaulted to manual).</li>
      <li><code>referrer:</code> A USVString specifying no-referrer, client, or a URL. The default is client.</li>
      <li><code>referrerPolicy:</code> Specifies the value of the referer HTTP header. May be one of no-referrer, no-referrer-when-downgrade, origin, origin-when-cross-origin, unsafe-url.</li>
      <li><code>integrity:</code> Contains the subresource integrity value of the request (e.g., sha256-BpfBw7ivV8q2jLiT13fxDYAe2tJllusRSZ273h2nFSE=).</li>
      <li><code>keepalive:</code> The keepalive option can be used to allow the request to outlive the page. Fetch with the keepalive flag is a replacement for the Navigator.sendBeacon() API.</li>
      <li><code>signal:</code> An AbortSignal object instance; allows you to communicate with a fetch request and abort it if desired via an AbortController.<br><br></li>

      <li><code>responseType:</code> <i>(Optional, FireMonkey only)</i><br>
      You can set a responseType for the response e.g: <code>'text'</code> <i>(default)</i>, <code>'json'</code>, <code>'blob'</code>, <code>'arrayBuffer'</code>, <code>'formData'</code></li>
    </ul>



  <figure>
    <figcaption>Example</figcaption>
  <pre><span class="comment">// simplest, returns response text</span>
<span class="keyword">const</span> response = <span class="keyword">await</span> <span class="gm">GM</span>.<span class="method">fetch</span>(<span class="string">'https://example.com/etc'</span>);

<span class="comment">// with init, returns response text</span>
<span class="keyword">const</span> response = <span class="keyword">await</span> <span class="gm">GM</span>.<span class="method">fetch</span>(<span class="string">'https://example.com/etc'</span>, {
  method: <span class="string">'POST'</span>,
  <span class="property">body</span>: <span class="object">JSON</span>.<span class="method">stringify</span>(data), <span class="comment">// data can be `string` or {object}!</span>
  headers:{
    <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>
});

<span class="comment">// returns response JSON</span>
<span class="keyword">const</span> response = <span class="keyword">await</span> <span class="gm">GM</span>.<span class="method">fetch</span>(<span class="string">'https://example.com/etc'</span>, {responseType: <span class="string">'json'</span>});

<span class="comment">// if you don't need to wait for the response</span>
<span class="gm">GM</span>.<span class="method">fetch</span>(<span class="string">'https://example.com/etc'</span>)
.<span class="method">then</span>(response =&gt; callback(response))
.<span class="keyword">catch</span>(<span class="method">error</span> =&gt; <span class="property">console</span>.<span class="method">error</span>(<span class="method">error</span>.message));</pre>
  </figure>


  <h3 id="xmlHttpRequest">xmlHttpRequest</h3>
  <p><code>GM.xmlHttpRequest/GM_xmlhttpRequest</code> is the xmlHttpRequest interface and mostly compatible with <i>GreaseMonkey</i> API.</p>
  <p>All requests are <code>asynchronous</code>, therefore <i>GreaseMonkey</i> <code>synchronous</code> is not supported.</p>

  <figure>
    <figcaption>Request</figcaption>
<pre>GM.xmlHttpRequest({
  url,                      // http, https, <s>ftp, ftps</s> <a href="#ftp" title="What to expect for the upcoming deprecation of FTP in Firefox">[*]</a>, (file not allowed), can be relative to the web page

  method,                   // Optional, defaults to 'GET' if omitted
  headers,                  // optional, header object to send with the request
  data,                     // optional, e.g. POST data
  overrideMimeType,         // optional, MIME type to send with the request
  user,                     // optional, username to send with the request
  password,                 // optional, password to send with the request
  timeout,                  // optional, number of milliseconds before terminating the request
                               (default 0 = no timeout)
  withCredentials,          // optional, Boolean, for cross-site Access-Control
                               e.g. cookies, authorization headers or TLS client certificates,
                               defaults to false, no effect on same-site requests
  responseType              // Optional, '' or 'text' (default), 'arraybuffer', 'blob', 'document', 'json'
                               if used, get the result from response (not responseText)

  onload,                   // callback function
  onerror,                  // callback function
  onabort,                  // callback function
  ontimeout,                // callback function
});</pre>
  </figure>


  <figure>
    <figcaption>Callback Response <span>returns response object</span></figcaption>
<pre>onload, onerror, ontimeout, onabort
{
  readyState
  response
  responseHeaders
  responseText
  responseType
  responseURL
  responseXML
  status
  statusText
  finalUrl                  // clone of responseURL for GM/TM/VM compatibility
}
</pre>
  </figure>


  <figure>
    <figcaption>Example</figcaption>
  <pre><span class="comment">// simplest</span>
<span class="gm">GM.xmlHttpRequest</span>({
  url: <span class="string">'https://example.com/etc'</span>,
  <span class="property">onload</span>: response =&gt; {
    <span class="property">console</span>.<span class="method">log</span>(response.<span class="property">responseText</span>);
  }
});

<span class="comment">// POST request</span>
<span class="gm">GM.xmlHttpRequest</span>({
  url: <span class="string">'https://example.com/etc'</span>,
  method: <span class="string">'POST'</span>,
  data: <span class="object">JSON</span>.<span class="method">stringify</span>(data), <span class="comment">// data can be `string` or {object}!</span>
  headers:{
    <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>
  }
  <span class="property">onload</span>: response =&gt; {
    <span class="property">console</span>.<span class="method">log</span>(response.<span class="property">responseText</span>);
  },
  <span class="property">onerror</span>: response =&gt; {
    <span class="property">console</span>.<span class="method">log</span>(`${response.<span class="property">status</span>}  ${response.<span class="property">statusText</span>}`);
  },
);

<span class="comment">// HEAD request</span>
<span class="gm">GM.xmlHttpRequest</span>({
  url: <span class="string">'https://example.com/etc'</span>,
  method: <span class="string">'HEAD'</span>,
  <span class="property">onload</span>: response =&gt; {
    <span class="property">console</span>.<span class="method">log</span>(response.<span class="property">responseHeaders</span>);
  }
});</pre>
  </figure>


  <h4>xmlHttpRequest withCredentials</h4>
  <p><code>GM.xmlHttpRequest/GM_xmlhttpRequest</code> are sent from background script where credentials are not available. Sometimes it is necessary to send <code>xmlHttpRequest</code> from the page scope.</p>


  <figure>
    <figcaption>xmlHttpRequest from Page Scope</figcaption>
<pre>
<span class="keyword">const</span> xhr = XPCNativeWrapper(<span class="keyword">new</span> <span class="object">window</span>.wrappedJSObject.XMLHttpRequest());
xhr.<span class="method">open</span>(<span class="string">'GET'</span>, <span class="string">'https://example.com/etc'</span>);
xhr.withCredentials = <span class="keyword">true</span>;
xhr.<span class="property">onload</span> = response =&gt; {
 <span class="property">console</span>.<span class="method">log</span>(response.<span class="property">responseText</span>);
},
xhr.<span class="property">onerror</span> = response =&gt; {
 <span class="property">console</span>.<span class="method">log</span>(`${response.<span class="property">status</span>}  ${response.<span class="property">statusText</span>}`);
}
xhr.send(<span class="keyword">null</span>);
</pre>


  </figure>




  <h3 id="forbidden-header-name">Forbidden header name</h3>
  <p>A <a href="https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_header_name" target="_blank">forbidden header name</a> (also <a href="https://fetch.spec.whatwg.org/#forbidden-header-name" target="_blank">forbidden header name</a>) is the name of any <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" target="_blank">HTTP header</a> that cannot be modified programmatically; specifically, an HTTP <b>request</b> header name (in contrast with a Forbidden response header name).</p>

  <p>Modifying such headers is forbidden because the user agent retains full control over them. Names starting with `<code>Sec-</code>` are reserved for creating new headers safe from APIs using <code>fetch</code> that grant developers control over headers, such as <code>XMLHttpRequest</code>.</p>

  <p>All Forbidden header names will be removed from the request by <i>FireMonkey</i> before sending.</p>

  <p>Forbidden header names start with <code>Proxy-</code> or <code>Sec-</code>, or are one of the following names:</p>
  <ul style="columns: 2;">
    <li>Accept-Charset</li>
    <li>Accept-Encoding</li>
    <li>Access-Control-Request-Headers</li>
    <li>Access-Control-Request-Method</li>
    <li>Connection</li>
    <li>Content-Length</li>
    <li>Cookie</li>
    <li>Cookie2</li>
    <li>Date</li>
    <li>DNT</li>
    <li>Expect</li>
    <li>Host</li>
    <li>Keep-Alive</li>
    <li>Origin</li>
    <li>Proxy-</li>
    <li>Sec-</li>
    <li>Referer</li>
    <li>TE</li>
    <li>Trailer</li>
    <li>Transfer-Encoding</li>
    <li>Upgrade</li>
    <li>Via</li>
  </ul>

  <p>After confirmation from AMO (ref 2019-09-28 Rob W), modification to the following Forbidden headers will be allowed:</p>
  <ul style="columns: 2;">
    <li>Cookie</li>
    <li>Host</li>
    <li>Origin</li>
    <li>Referer</li>
  </ul>

  <h3 id="notification">notification(text)</h3>
  <p>Currently, only plain text is processed for notification. For compatibility, options object <code>{text, title, image, onclick}</code> is processed and the text is passed for notification.</p>
  <p>Notes on notification options:</p>
  <dl>
    <dt>text</dt>
      <dd>text string</dd>

    <dt>title</dt>
      <dd><span class="fail"></span>Not processed, script name shows as title</dd>

    <dt>image</dt>
      <dd>a data URL, a blob URL, a http or https URL</dd>

    <dt>onclick</dt>
      <dd><span class="fail"></span>Not processed, maybe added on popular demand</dd>

  </dl>
  
<pre>
<span class="gm">GM_notification</span>(<span class="string">'some text'</span>);
<span class="gm">GM_notification</span>({text: <span class="string">'some text'</span>, image: <span class="string">'https://example.com/icon.jpg'</span>, ...});
</pre>  


  <h3 id="registerMenuCommand">registerMenuCommand(name, onclick)</h3>
  <p>If there are Script Commands for a tab, they will be listed at the bottom of toolbar pop-up under their user-script name. Please note that <i>onclick</i> must be a <i>function</i>.</p>

  <figure>
    <figcaption>Example</figcaption>
<pre><code class="deprecated"><span class="comment">// direct method -> error: alert runs immediately</span>
<span class="gm">GM_registerMenuCommand</span>(<span class="string">'Hello, world (direct)'</span>, <span class="method">alert</span>(<span class="string">'Hello, world! (direct)'</span>));</code>
<span class="comment">// anonymous function</span>
<span class="gm">GM_registerMenuCommand</span>(<span class="string">'Hello, world (anon)'</span>, <span class="keyword">function</span>() { <span class="method">alert</span>(<span class="string">'Hello, world! (anon)'</span>); });

<span class="comment">// named function</span>
<span class="keyword">function</span> sayHello() { <span class="method">alert</span>(<span class="string">'Hello, world! (named)'</span>); }
<span class="gm">GM.registerMenuCommand</span>(<span class="string">'Hello, world (named)'</span>, sayHello);
</pre>
  </figure>

  <h3 id="unregisterMenuCommand">unregisterMenuCommand(name)</h3>
  <p>Unregistered the previously created script menu.</p>
<pre>
<span class="gm">GM.unregisterMenuCommand</span>(<span class="string">'Hello, world (named)'</span>);
</pre>

  <h3 id="getResourceText">getResourceText(resourceName)</h3>
  <p>The API is added for convenience and compatibility but it works differently in comparison to other script managers as the target is not not stored. It uses <code>fetch()</code> to get the target the first time but on subsequently <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request/cache" target="_blank">Request.cache</a> will be used by the browser.</p>

<pre>
<span class="keyword">const</span> text = <span class="keyword">await</span> <span class="gm">GM_getResourceText</span>(<span class="string">'resourceName'</span>);
</pre>


  <h3 id="getResourceUrl">getResourceUrl(resourceName)</h3>
  <p>The API is added for convenience and compatibility but it works differently in comparison to other script managers as the target is not not stored. It maps directly to the <i>resourceURL</i> and returns the URL, or <code>undefined</code>.</p>

<pre>
<span class="keyword">const</span> url = <span class="gm">GM_getResourceUrl</span>(<span class="string">'resourceName'</span>);
</pre>


  <h3 id="addValueChangeListener">addValueChangeListener(key, callback)</h3>
  <p>Script storage change listener that returns the key as listener ID (although not necessary in FireMonkey).</p>
  <p><code>(key, oldValue, newValue, remote)</code> are passed to the callback function.</p>

  <ul>
    <li><b>key</b>: the storage key</li>
    <li><b>oldValue</b>: original value or <code>undefined</code> if it was created</li>
    <li><b>newValue</b>: new value or or <code>undefined</code> if it was deleted</li>
    <li><b>remote</b>: <code>true</code> if change came from another tab or <code>false</code> if from the same tab</li>
  </ul>


<pre>
<span class="comment">// anonymous function</span>
<span class="gm">GM_addValueChangeListener</span>(<span class="string">'test-key'</span>, <span class="keyword">function</span>(...arg) { <span class="property">console</span>.<span class="method">log</span>(...arg); });

<span class="comment">// anonymous arrow function</span>
<span class="gm">GM_addValueChangeListener</span>(<span class="string">'test-key'</span>, (key, oldValue, newValue, remote) => { <span class="property">console</span>.<span class="method">log</span>(key, oldValue, newValue, remote); });
</pre>



  <h3 id="removeValueChangeListener">removeValueChangeListener(key)</h3>
  <p>Remove listener for <code>key</code></p>

<pre>
<span class="gm">GM_removeValueChangeListener</span>(<span class="string">'test-key'</span>);
</pre>


  <h3 id="download">download(url <i>[, filename]</i>)</h3>
  <p>Simple file download from the Internet. <code>url</code> must be valid but <code>filename</code> is optional.</p>
  <p><code>url</code>: http, https, <s>ftp, ftps</s> <a href="#ftp" title="What to expect for the upcoming deprecation of FTP in Firefox">[*]</a>, (file not allowed), can be relative to the web page</p>
  <p>If the specified <code>url</code> uses the HTTP or HTTPS protocol, then the request will include all cookies currently set for its hostname.</p>

<pre>
<span class="gm">GM_download</span>(<span class="string">'https;//www.example.com/icon.jpg'</span>);
<span class="gm">GM_download</span>(<span class="string">'https;//www.example.com/icon.jpg'</span>, <span class="string">'new-name.jpg'</span>);
</pre>

  <h3 id="info">info</h3>
<pre>{
  scriptHandler:    'FireMonkey',
  version:          'e.g. 1.29',
  scriptMetaStr:    null,
  platform: {
    os:             'e.g. mac win android cros linux openbsd',
    arch            'e.g. arm x86-32 x86-64'
  },
  browser: {
    name:           'e.g. Firefox',
    vendor:         'e.g. Mozilla',
    version:        'e.g. 75.0a1'.
    buildID:        'e.g. 20200220224950'
  },
  script: {
    name:           'script name',
    version:        'script version',
    description:    'script description',
    matches:        [array of match/matches/include],
    includes:       [array of match/matches/include],
    excludes:       [array of exclude/excludeMatches],
    'run-at':       'e.g. document-idle',
    namespace:      null,
    resources:      {object of name: url}
  }
}</pre>

  <h3 id="log">log</h3>
  <p>The API is added for convenience and compatibility and is no longer supproted by GreaseMonkey or ViolentMonkey but TamperMonkey still has it. Multiple parameters can be passed e.g. <code>GM_log('one', 'two', 'three')</code>. You can also use <code>console.log()</code> instead.</p>

<pre>
<span class="gm">GM_log</span>(<span class="string">'one'</span>);
<span class="gm">GM.log</span>(<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>);
<span class="gm">GM_log</span>(<span class="gm">GM_info</span>);
</pre>

  <h3 id="unsafeWindow">unsafeWindow &#x26a0;&#xfe0f;</h3>
  <p><code>unsafeWindow</code> in <i>FireMonkey</i> is an alias for <code>window.wrappedJSObject</code>. You can also use <code>window.wrappedJSObject</code> or <code>window.eval()</code> to access page JavaScript <b>globals</b>.</p>
  <p>Please note that <code>window.eval()</code> makes the object available to the page script as well while <code>unsafeWindow</code>, <code>window.wrappedJSObject</code> does not.</p>

  <figure>
    <figcaption>Example</figcaption>
<pre>
<span class="comment">// page-script.js</span>
<span class="keyword">var</span> foo = <span class="string">"I'm defined in a page script!"</span>;
<span class="keyword">function</span> runTest() {
  <span class="property">console</span>.<span class="method">log</span>(foo);
}

<span class="comment">// content-script.js</span>
<span class="property">console</span>.<span class="method">log</span>(window.foo); <span class="comment">// undefined</span>
<span class="property">console</span>.<span class="method">log</span>(<span class="gm">unsafeWindow</span>.foo); <span class="comment">// "I'm defined in a page script!"</span>
<span class="property">console</span>.<span class="method">log</span>(window.wrappedJSObject.foo); <span class="comment">// "I'm defined in a page script!"</span>
<span class="gm">unsafeWindow</span>.runTest(); <span class="comment">// "I'm defined in a page script!"</span>
<span class="object">window</span>.wrappedJSObject.runTest(); <span class="comment">// "I'm defined in a page script!"</span>



<span class="comment">// overriding window functions</span>
<span class="keyword">let</span> <span class="method">hasFocus</span> = <span class="keyword">new</span> <span class="object">window</span>.<span class="object">Function</span>(<span class="string">'return true'</span>);
<span class="gm">unsafeWindow</span>.<span class="property">document</span>.<span class="method">hasFocus</span> = <span class="method">hasFocus</span>;

<span class="comment">// another example</span>
<span class="object">Object</span>.defineProperty(<span class="gm">unsafeWindow</span>.<span class="property">document</span>, <span class="string">'hidden'</span>, {<span class="property">value</span>: <span class="keyword">false</span>});
</pre>
</figure>



  <blockquote>This API object allows a User script to access "custom" properties--variable and functions defined in the page--set by the web page. The <code>unsafeWindow</code> object is shorthand for <code>window.wrappedJSObject</code>. It is the raw window object inside the <code>XPCNativeWrapper</code> provided by the Greasemonkey Sandbox.<br><br>

  <b>USE OF UNSAFEWINDOW IS INSECURE, AND IT SHOULD BE AVOIDED WHENEVER POSSIBLE.</b>
  <cite><a href="https://sourceforge.net/p/greasemonkey/wiki/unsafeWindow/" target="_blank">unsafeWindow</a></cite></blockquote>

  <p>Safer alternatives to <code>unsafeWindow</code> are also listed in above page.</p>
  

  <blockquote>This command can open certain security holes in your user script, and it is recommended to use this command sparingly.<br>

  Please be sure to read the entire article and understand it before using it in a script.

  <cite><a href="https://wiki.greasespot.net/UnsafeWindow" target="_blank">unsafeWindow</a></cite></blockquote>


  <h4>exportFunction() & cloneInto()</h4>
  <p><code>unsafeWindow</code>, <code>window.wrappedJSObject</code> or <code>window.eval()</code> can be used to create function & objects.</p>

<pre><span class="gm">unsafeWindow</span>.testFunc = <span class="keyword">function</span>() { <span class="property">console</span>.<span class="method">log</span>(location.<span class="property">href</span>); }
<span class="gm">unsafeWindow</span>.testFunc(); <span class="comment">// https://example.com/</span>


<span class="gm">unsafeWindow</span>.obj = {text: <span class="string">'hello from user-script'</span>};
<span class="property">console</span>.<span class="method">log</span>(<span class="gm">unsafeWindow</span>.obj.text); <span class="comment">// hello from user-script</span></pre>


  <h3 id="xray-vision">&#x2139;&#xFE0F; <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/Xray_vision" target="_blank">Xray Vision</a> & Sharing objects with page scripts</h3>

  <h4>Extension JavaScript Context/Scope</h4>
  <ol style="list-style-type: upper-roman;">
    <li>Browser Scope: Trusted privileged code to interact with browser</li>
    <li>Content Scope: Trusted extension JS injected into web page with API privileges</li>
    <li>User-Script Scope: Untrusted unverified 3rd party JS injected into web page without direct API privileges</li>
    <li>Page Scope: JS injected in a web page by the website</li>
  </ol>

  <blockquote>As an extension developer you should consider that scripts running in arbitrary web pages are hostile code whose aim is to steal the user's personal information, damage their computer, or attack them in some other way.<br><br>

  The isolation between content scripts and scripts loaded by web pages is intended to make it more difficult for hostile web pages to do this.<br><br>

  Since the techniques described in this section break down that isolation, they are inherently dangerous and should be used with great care.<br>
  ...<br>
  Note that once you do this, you can no longer rely on any of this object's properties or functions being, or doing, what you expect. Any of them, even setters and getters, could have been redefined by untrusted code.

  <cite><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Sharing_objects_with_page_scripts" target="_blank">Sharing objects with page scripts</a></cite></blockquote>


  <blockquote>By default, content scripts don't get access to objects created by page scripts. However, they can communicate with page scripts using the DOM <code>window.postMessage</code> and <code>window.addEventListener</code> APIs.

  <cite><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#Communicating_with_the_web_page" target="_blank">Communicating with the web page</a></cite></blockquote>

  <blockquote>In Chrome, <code>eval()</code> always runs code in the context of the content script, not in the context of the page.<br>

  In Firefox:
      <ul>
        <li>If you call <code>eval()</code>, it runs code in the context of the content script.</li>
        <li>If you call <code>window.eval()</code>, it runs code in the context of the page.</li>
      </ul>

  <cite><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#Using_eval_in_content_scripts" target="_blank">Using eval() in content scripts</a></cite></blockquote>



  <h4>Injecting code into page scripts</h4>
  <p>Sometimes it is necessary to have a script that is available to page spirit and/or run in page context, as an extension to page script functions.</p>
  
<pre><span class="keyword">const</span> script = <span class="property">document</span>.<span class="method">createElement</span>(<span class="string">'script'</span>);
script.<span class="property">textContent</span> = <span class="string">`... code ...`</span>;
<span class="property">document</span>.<span class="property">body</span>.<span class="method">appendChild</span>(script);
script.<span class="method">remove</span>();
</pre>
<p>More: <a href="https://stackoverflow.com/questions/9515704/insert-code-into-the-page-context-using-a-content-script/9517879#9517879" target="_blank">Insert code into the page context using a content script</a> by Rob W</p>

  <h4>Receiving data from page scripts</h4>
  <p><a href="https://developer.mozilla.org/docs/Web/API/CustomEvent" target="_blank">CustomEvent</a> can be used send data from a page script.</p>
  
  <figure>
    <figcaption>Example with &lt;script&gt;</figcaption>
<pre>
<span class="comment">// inject a function that generates &amp; dispatches a CustomEvent</span>
<span class="keyword">const</span> script = <span class="property">document</span>.<span class="method">createElement</span>(<span class="string">'script'</span>);
script.<span class="property">textContent</span> = `function sendMessage(message) =&gt; {
  <span class="object">window</span>.<span class="method">dispatchEvent</span>(<span class="keyword">new</span> CustomEvent(<span class="string">'sendMessage'</span>, {detail: message}));
};

<span class="comment">// run sendMessage when needed</span>
<span class="keyword">if</span>(... condition ...) { sendMessage(data); }
<span class="string">`</span>;
<span class="property">document</span>.<span class="property">head</span>.<span class="method">appendChild</span>(script);
script.<span class="method">remove</span>();

<span class="comment">// in user-script</span>
<span class="object">window</span>.<span class="method">addEventListener</span>(<span class="string">'sendMessage'</span>, onMessage);
<span class="keyword">function</span> onMessage(e) {

  <span class="keyword">const</span> message = e.detail;
  <span class="comment">// run some code</span>
}
</pre>
</figure>  

  <p>In Firefox, <code>window.eval()</code> can also be used to inject code into a page context.</p>

  <figure>
    <figcaption>Example with window.eval()</figcaption>
<pre>
<span class="comment">// inject a function that generates &amp; dispatches a CustomEvent</span>
<span class="object">window</span>.<span class="method">eval</span>(`function sendMessage(message) =&gt; {
  <span class="object">window</span>.<span class="method">dispatchEvent</span>(<span class="keyword">new</span> CustomEvent(<span class="string">'sendMessage'</span>, {detail: message}));
};

<span class="comment">// run sendMessage when needed</span>
<span class="keyword">if</span>(... condition ...) { sendMessage(data); }
<span class="string">`</span>);

<span class="comment">// in user-script</span>
<span class="object">window</span>.<span class="method">addEventListener</span>(<span class="string">'sendMessage'</span>, onMessage);
<span class="keyword">function</span> onMessage(e) {

  <span class="keyword">const</span> message = e.detail;
  <span class="comment">// run some code</span>
}
</pre>
</figure>  

  <h2 id="UserCSS"><img src="../image/css.svg" alt=""> UserCSS</h2>
  
  <p>CSS can be injected directly into a page. If the goal is to inject CSS, it is by far more efficient to inject CSS as UserCSS, instead of using UserScript to inject CSS. Here is an example of simple UserCSS that I use to mark watched/visited videos on YouTube.</p>
  <p>Furthermore, CSS rules will apply to newly created elements in dynamically updated pages (e.g. on scroll) while JavaScript would need additional listeners to wait for new element to be created and then run then code again.</p>
  
  <figure>
    <figcaption>Example</figcaption>
<pre>
<span class="comment">==UserCSS==
@name           YouTube
@match          *://*.youtube.com/*
@author         erosman
@version        1.0
@run-at         document-start
==/UserCSS==
*/</span>


<span class="html">a</span>[href*="/watch?v="]<span class="pseudo">:visited</span>, <span class="html">a</span>[href*="/watch?v="]<span class="pseudo">:visited</span> yt-formatted-string,
<span class="html">a</span>[href*="/watch?v="]<span class="pseudo">:visited</span> h3 {
  <span class="property">color</span>: <span class="value">#f50</span> <span class="important">!important</span>;
}
</pre>
</figure>  


  <h2 id="UserStyle"><img src="../image/css.svg" alt=""> UserStyle</h2>
  
  <p>Partial compatibility with <a href="https://www.w3schools.com/css/css_syntax.asp" target="_blank">standard CSS syntax</a> UserStyle <code>==UserStyle== ... ==/UserStyle==</code> is available. All <code>url()</code>, <code>url-prefix()</code> & <code>domain()</code> are processed. Few very basic <code>regexp()</code> are converted to match pattern but other sections with <code>regexp()</code> are ignored since browser API does not support Regular Expression.</p>
  <p>The default <code>'run-at'</code> is set to <code>'document-start'</code> for UserStyles.</p>
  <p>Ref: <a href="https://github.com/erosman/support/issues/111" target="_blank">Implement Stylus style Compatibility</a> | 
    <a href="https://github.com/JasonBarnabe/greasyfork/issues/656" target="_blank">Support FireMonkey's UserCSS spec</a></p>
  
  
  <h3 id="stylish-stylus">&#x2139;&#xFE0F; Stylish/Stylus/xStyle Type UserStyle</h3>
  
  <p>In Firefox Quantum, extension can not use <code>@-moz-document</code> and therefore would have to:</p>

  <ul>
    <li>Break each UserStyle into sections for each <code>@-moz-document</code></li>
    <li>Add listeners to monitor changes to tab/iframe URLs</li>
    <li>Run a comparison loop against each tab and its iframes and each <code>@-moz-document</code> in every UserStyle</li>
    <li>If there is a match, inject the style section into the tab/iframe</li>
  </ul>

  <p>Above process is considerably resource intensive in comparison to using a dedicated API to inject Style/CSS.</p>


  <blockquote>-x- Implemented with the vendor prefix: `-moz-`<br><br>

* Notes Disabled by default in web pages, except for an empty <code>url-prefix()</code> value, which is supported due to its use in Firefox browser detection. Still supported in user stylesheets.<br><br>

🏴 Disabled From version 61: this feature is behind the <code>layout.css.moz-document.content.enabled</code> preference (needs to be set to <code>true</code>). To change preferences in Firefox, visit <code>about:config</code>.

  <cite><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@document" target="_blank">@document</a></cite></blockquote>
  
  <h4>Converting UserStyle @-moz-document to UserCSS @match</h4>
  <p>The first 3 are quite straight forward and easy to convert. The only difficulty is with the <code>regexp()</code>. The more complex the regexp (<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions" target="_blank">Regular Expressions</a>), the more <code>@match</code> may be needed, but once done, it is easy to read and maintain.</p>


<table>
  <caption>Conversion Guide</caption>
  <thead>
  <tr>
    <th>From</th>
    <th>To</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td><code>@-moz-document <strong>domain</strong>('images.example.com')</code></td>
    <td><code>@match      *://images.example.com/*</code></td>
  </tr>
  <tr>
    <td><code>@-moz-document <strong>url-prefix</strong>('http://www.example.com')</code></td>
    <td><code>@match      http://www.example.com/*</code></td>
  </tr>
  <tr>
    <td><code>@-moz-document <strong>url</strong>('http://www.example.com/test.html')</code></td>
    <td><code>@match      http://www.example.com/test.html</code></td>
  </tr>
  <tr>
    <td><code>@-moz-document <strong>regexp</strong>('http://www\\.example\\.(com|de)/images/.*')</code></td>
    <td><code>@match      http://www.example.com/images/*
@match      http://www.example.de/images/*</code></td>
  </tr>
  <tr>
    <td><code>@-moz-document <strong>regexp</strong>(''https?:\/\/(www\.|old\.)?reddit.com.*'')</code></td>
    <td><code>@match      *://*.reddit.com/*</code></td>
  </tr>
  </tbody>
</table>


  <h2 id="support"><img src="../image/help32.png" alt=""> Support</h2>
  <p>Please use the GitHub Community <a href="https://github.com/erosman/support" target="_blank">Support</a>.</p>

    </article>
  </body>
</html>
